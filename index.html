<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gu√≠a de estudio a entrenador MC (Firebase + Gemini)</title>
<style>
  /* --- Visual b√°sico (mantener) --- */
  body { margin:0; font-family:'Poppins',sans-serif; background:linear-gradient(to bottom right,#fffdf5,#fff); color:#222; text-align:center; }
  header { background:#fff; padding:20px 0; border-bottom:4px solid #ffc107; box-shadow:0 3px 10px rgba(0,0,0,0.1);}
  header img{ width:90px; vertical-align:middle } header h1{ display:inline-block; margin-left:10px; color:#c8102e; font-size:1.8rem; vertical-align:middle }
  main{ padding:40px 20px } .card{ background:#fff; border-radius:20px; display:inline-block; padding:30px; width:90%; max-width:900px; box-shadow:0 6px 25px rgba(0,0,0,0.15); border-top:6px solid #ffcc00; text-align:left; }
  input{ width:80%; max-width:360px; padding:12px; margin:10px auto; border-radius:8px; border:2px solid #ddd; display:block; text-align:center; }
  button{ margin:8px; background:#c8102e; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:700; }
  button.secondary{ background:#555 } button.warning{ background:#ffcc00; color:#222 } button.green-btn{ background:#2e7d32 }
  .meta{text-align:center;margin-bottom:10px;color:#777;font-size:.95rem} .section{font-weight:700;color:#c8102e;margin-bottom:8px;text-align:center}
  .question{font-size:1.2rem;font-weight:600;color:#222;margin:12px 0;text-align:center}.sourceLine{text-align:center;color:#555;font-size:.9rem;margin-bottom:10px}
  .feedback{ margin-top:16px;padding:14px;border-radius:10px;display:none;white-space:pre-wrap }
  .correct{ background:#e6ffed;color:#2e7d32;border-left:5px solid #2e7d32 }
  .incorrect{ background:#ffe6e6;color:#b71c1c;border-left:5px solid #b71c1c }
  .progress{text-align:center;margin-top:10px;color:#555;font-size:.95rem}
  #createModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000 }
  #createModal .modal-content{ background:#fff; padding:24px; border-radius:12px; max-width:420px; width:90%; text-align:center; box-shadow:0 6px 24px rgba(0,0,0,0.2) }
  #logList{ list-style:none; padding:0; max-height:360px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; margin-top:20px }
  footer{ margin-top:30px; padding:10px; font-size:0.9rem; color:#555; text-align:center }
  .hint{ font-size:0.85rem; color:#666; margin-top:8px }
</style>
</head>
<body>

<header>
  <img src="https://th.bing.com/th/id/R.466663e3e2b9cdbe29c5d4e0721ea9b7?rik=y%2b93vLaQvfidzg&riu=http%3a%2f%2fpngimg.com%2fuploads%2fmcdonalds%2fmcdonalds_PNG9.png" alt="Logo" />
  <h1>Gu√≠a de estudio a entrenador MC</h1>
</header>

<main>
  <div class="card">

    <!-- LOGIN -->
    <div id="loginView">
      <h2 style="color:#c8102e; font-size:2rem; margin-bottom:6px">Acceso a la Gu√≠a de Estudio</h2>
      <p id="promptText">Ingresa tu correo/contrase√±a o inicia con tu tel√©fono (SMS)</p>

      <input id="emailInput" type="email" placeholder="Correo electr√≥nico">
      <input id="passwordInput" type="password" placeholder="Contrase√±a">

      <div style="text-align:center">
        <button id="loginBtn">Iniciar Sesi√≥n</button>
        <button id="showCreateBtn" class="secondary">Crear Cuenta</button>
        <button id="phoneAuthBtn" class="warning" style="background:#00a2ff;color:#fff">Iniciar con SMS</button>
      </div>

      <p id="feedbackMsg" style="color:red; margin-top:10px"></p>

      <div id="phoneAuthArea" style="display:none; margin-top:12px">
        <input id="phoneNumberInput" placeholder="+52xxxxxxxxxx (incluye pa√≠s)">
        <div id="recaptcha-container" style="margin: 8px auto;"></div>
        <button id="sendSmsBtn" class="secondary">Enviar c√≥digo</button>
        <div id="smsCodeArea" style="display:none; margin-top:8px">
          <input id="smsCodeInput" placeholder="C√≥digo SMS">
          <button id="verifySmsBtn" class="green-btn">Verificar c√≥digo</button>
        </div>
        <p class="hint">Si usas SMS, tu n√∫mero debe estar autorizado en Firebase Console si usas sandbox.</p>
      </div>

      <div id="optionsMenu" style="display:none; margin-top: 18px;">
        <p id="welcomeUserMsg" style="font-weight:600;"></p>
        <button id="startQuizBtn" style="background:#ffc107;color:#222">Iniciar Quiz</button>
        <button id="panelCreatorBtn" class="secondary" style="display:none">Panel de Creador</button>
        <button id="logoutBtn" class="warning" style="background:#b71c1c">Cerrar Sesi√≥n</button>
      </div>
    </div>

    <!-- CREATOR PANEL -->
    <div id="creatorView" style="display:none">
      <h2>Panel de Creador (Logs locales)</h2>
      <p style="font-size:0.85em;color:red;">‚ö†Ô∏è Importante: el registro local es visible solo en este navegador.</p>
      <ul id="logList"><li>No hay registros a√∫n.</li></ul>
      <div style="margin-top:12px">
        <button id="downloadLogBtn" class="green-btn">Descargar Log (CSV)</button>
        <button id="clearLogBtn" class="warning">Limpiar Registro</button>
        <button id="backToMenuBtn" class="secondary">Volver al Men√∫</button>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quizView" style="display:none;">
      <div class="meta" id="currentUserName"></div>
      <div id="section" class="section">Presiona "Iniciar" para comenzar</div>
      <div id="question" class="question"></div>
      <div id="sourceLine" class="sourceLine"></div>

      <input id="userAnswer" type="text" placeholder="Escribe tu respuesta aqu√≠..." style="display:none">

      <div id="feedback" class="feedback"></div>

      <div class="buttons">
        <button id="startBtn">Iniciar</button>
        <button id="checkBtn" style="display:none">Comprobar</button>
        <button id="nextBtn" style="display:none">Siguiente</button>
        <button id="finishBtn" class="warning" style="display:none">Terminar</button>
        <button id="restartBtn" class="secondary" style="display:none">Reiniciar</button>
      </div>

      <div id="progress" class="progress"></div>
    </div>

  </div>
</main>

<!-- CREATE ACCOUNT MODAL -->
<div id="createModal">
  <div class="modal-content">
    <h3>Crear Cuenta</h3>
    <input id="newName" placeholder="Nombre completo">
    <input id="newPuesto" placeholder="Puesto">
    <input id="newEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="newPassword" type="password" placeholder="Contrase√±a (m√≠n 6 caracteres)">
    <div style="margin-top:10px">
      <button id="createAccountBtn">Crear Cuenta</button>
      <button id="closeModalBtn" class="secondary">Cancelar</button>
    </div>
    <p id="createFeedback" style="color:red; margin-top:8px"></p>
  </div>
</div>

<footer>¬© 2025 Mc | Proyecto de Entrenamiento MC üçü</footer>

<script type="module">
/* ====================================================
   CONFIG / VARIABLES IMPORTANTES (edita seg√∫n necesites)
   ==================================================== */

/* --- Firebase SDK imports (v11 recommended) --- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  RecaptchaVerifier,
  signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ---------- FIREBASE config ---------- 
   Reemplaza por la configuraci√≥n exacta de tu proyecto (la de Firebase Console).
   Aseg√∫rate que el dominio github.io est√° en Dominios autorizados para Auth.
*/
const firebaseConfig = {
  apiKey: "AIzaSyB57-QWSTYwBmbwf5cK0mHVJSYCdkBCxkM",
  authDomain: "mcantea.firebaseapp.com",
  projectId: "mcantea",
  storageBucket: "mcantea.appspot.com", // corregir si es necesario
  messagingSenderId: "364639775835",
  appId: "1:364639775835:web:aee974c576c2e4d515237e",
  measurementId: "G-0BYWEJJ57G"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- CSV (quiz) ---------- */
const QUIZ_CSV_URL = "https://raw.githubusercontent.com/alexc316/MC/main/Guia_de_entrenamiento_MC.csv";

/* ---------- ADMIN / CREATOR ---------- */
const CREATOR_EMAIL = "alexis@mc.com"; // admin email que pediste
const LOG_KEY = "mc_firebase_access_log";

/* ---------- GEMINI (CONFIG) ----------
 You have two modes:
  - GEMINI_USE_PROXY=true -> the page will call your proxy endpoint (recommended)
  - GEMINI_USE_PROXY=false -> the page will attempt to call Google GenAI endpoint directly (not recommended for public repos)
 If you choose direct, the API key is included below (you told me you'll secure repo). Prefer proxy in production.
*/
const GEMINI_USE_PROXY = false; // set true to call your proxy (recommended)
const GEMINI_PROXY_URL = "https://your-proxy.example.com/gemini-eval"; // replace with your proxy (if used)
const GEMINI_API_KEY = "AIzaSyCph7k-jLhd-AimQP1hyGiwtXlZoYAzaMU"; // your key (if direct)

/* Model info */
const GEMINI_MODEL = "gemini-1.5-flash";

/* ====================================================
   Estado del app
   ==================================================== */
let quizData = [];
let currentUserData = null; // {uid,email,nombre,puesto}
let randomized = [];
let currentIndex = 0;
let correctCount = 0;
let wrongCount = 0;

/* DOM shortcuts */
const loginView = document.getElementById('loginView');
const quizView = document.getElementById('quizView');
const creatorView = document.getElementById('creatorView');
const feedbackMsg = document.getElementById('feedbackMsg');
const optionsMenu = document.getElementById('optionsMenu');

/* modal */
const createModal = document.getElementById('createModal');
const createFeedback = document.getElementById('createFeedback');

/* phone auth elements */
const phoneAuthArea = document.getElementById('phoneAuthArea');
const phoneAuthBtn = document.getElementById('phoneAuthBtn');

/* ====================================================
   UTIL (normalize, similarity, levenshtein)
   ==================================================== */
function normalizeText(s) {
  if (!s) return "";
  let t = String(s).toLowerCase().trim();
  t = t.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  t = t.replace(/[^\p{L}\p{N}\s]/gu, '');
  t = t.replace(/\s+/g, ' ').trim();
  return t;
}

function levenshtein(a, b) {
  if (!a) return b.length;
  if (!b) return a.length;
  const m = a.length, n = b.length;
  const dp = Array.from({length: m+1}, () => new Array(n+1).fill(0));
  for (let i=0;i<=m;i++) dp[i][0]=i;
  for (let j=0;j<=n;j++) dp[0][j]=j;
  for (let i=1;i<=m;i++){
    for (let j=1;j<=n;j++){
      dp[i][j] = Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1] + (a[i-1]===b[j-1] ? 0 : 1)
      );
    }
  }
  return dp[m][n];
}

function isSimilar(a, b) {
  // 1) normalization + direct substring or equality
  const A = normalizeText(a);
  const B = normalizeText(b);
  if (!A || !B) return false;
  if (A === B) return true;
  if (A.includes(B) || B.includes(A)) return true;

  // 2) token overlap
  const wordsA = A.split(' ');
  const wordsB = B.split(' ');
  const setB = new Set(wordsB);
  let common = 0;
  for (const w of wordsA) if (setB.has(w)) common++;
  const ratio = common / Math.max(wordsA.length, wordsB.length);
  if (ratio >= 0.6) return true;

  // 3) Levenshtein on whole strings (tolerate small typos)
  const lev = levenshtein(A, B);
  const levRatio = lev / Math.max(A.length, B.length);
  if (levRatio <= 0.25) return true; // 25% edits allowed

  return false;
}

/* ====================================================
   Gemini eval helper
   - if GEMINI_USE_PROXY true -> POST to GEMINI_PROXY_URL with {userAnswer, correctAnswer, question}
   - else try direct call to GenAI endpoint (may require API key)
   Returns: "correct" or "incorrect" (string)
   ==================================================== */
async function evaluateWithGemini(userAnswer, correctAnswer, questionText) {
  try {
    if (GEMINI_USE_PROXY) {
      // Proxy expected to return {result: "correct" | "incorrect"}
      const res = await fetch(GEMINI_PROXY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userAnswer, correctAnswer, question: questionText })
      });
      const j = await res.json();
      return j && j.result ? j.result : "incorrect";
    } else {
      // Direct call to Generative API (warning: exposing API key in client)
      // Example endpoint: v1beta/models/<model>:generateText (may change)
      // We'll use generateText style body (best-effort). If it errors, fallback to "incorrect".
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(GEMINI_MODEL)}:generateText?key=${encodeURIComponent(GEMINI_API_KEY)}`;
      const prompt = `Eval√∫a si la respuesta del usuario significa lo mismo que la respuesta correcta.\nPregunta: "${questionText}"\nRespuesta esperada: "${correctAnswer}"\nRespuesta del usuario: "${userAnswer}"\nResponde solo con una palabra: "correct" si el significado es equivalente, o "incorrect" si no lo es.`;
      const body = {
        temperature: 0.0,
        maxOutputTokens: 64,
        prompt: { text: prompt }
      };
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const j = await res.json();
      // Attempt to parse the text response safely
      let text = "";
      if (j && (j.candidates || j.output)) {
        // different API shapes:
        if (j.candidates && j.candidates[0] && j.candidates[0].content) text = j.candidates[0].content;
        else if (j.output && j.output[0] && j.output[0].content) text = j.output[0].content;
        else text = JSON.stringify(j);
      } else {
        text = JSON.stringify(j);
      }
      text = String(text).toLowerCase();
      if (text.includes("correct")) return "correct";
      if (text.includes("incorrect")) return "incorrect";
      // fallback: if the model expresses high similarity words, accept as correct
      if (text.includes("s√≠") || text.includes("si") || text.includes("equivalen") || text.includes("similar")) return "correct";
      return "incorrect";
    }
  } catch (e) {
    console.error("Gemini eval error:", e);
    return "incorrect";
  }
}

/* ====================================================
   CSV loader (robusto)
   ==================================================== */
async function processCSV(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Error al cargar CSV: ' + res.statusText);
    const raw = await res.text();
    const clean = raw.replace(/^\uFEFF/, '').trim();
    const delimiter = clean.includes(';') ? ';' : ',';
    const rows = clean.split(/\r?\n/).map(line =>
      line.split(new RegExp(`${delimiter}(?=(?:(?:[^"]*"){2})*[^"]*$)`)).map(cell => cell.replace(/(^"|"$)/g, '').trim())
    ).filter(r => r.length>0);
    if (rows.length < 2) return [];
    const header = rows[0].map(h => h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9_]+/g,'_'));
    const idx = {
      section: header.findIndex(h => /secci|section|categoria|area/.test(h)),
      question: header.findIndex(h => /pregunt|question|cuestio/.test(h)),
      answer: header.findIndex(h => /respuest|answer|soluci/.test(h)),
      source: header.findIndex(h => /fuente|source|origen/.test(h))
    };
    return rows.slice(1).map(r => ({
      section: r[idx.section] || '',
      question: r[idx.question] || '',
      answer: r[idx.answer] || '',
      source: r[idx.source] || ''
    })).filter(x => x.question && x.answer);
  } catch (e) {
    console.error(e);
    return [];
  }
}

/* ====================================================
   Firestore helper to get user profile
   ==================================================== */
async function getFirestoreUserData(uid){
  try {
    const d = await getDoc(doc(db, "usuarios", uid));
    if (d.exists()) return d.data();
    return null;
  } catch(e) {
    console.error("Error get user doc:", e);
    return null;
  }
}

/* ====================================================
   Login / Create / Phone Auth logic
   ==================================================== */
function showLoginScreen(){
  currentUserData = null;
  document.getElementById('emailInput').value = '';
  document.getElementById('passwordInput').value = '';
  feedbackMsg.innerText = '';
  loginView.style.display = 'block';
  quizView.style.display = 'none';
  creatorView.style.display = 'none';
  optionsMenu.style.display = 'none';
  document.getElementById('loginBtn').style.display = 'inline-block';
  document.getElementById('showCreateBtn').style.display = 'inline-block';
  phoneAuthArea.style.display = 'none';
}

/* Email/password login */
document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('emailInput').value.trim();
  const password = document.getElementById('passwordInput').value.trim();
  feedbackMsg.innerText = '';
  if (!email || !password) { feedbackMsg.innerText = "Ingresa correo y contrase√±a"; return; }
  try {
    const uc = await signInWithEmailAndPassword(auth, email, password);
    const user = uc.user;
    const fdata = await getFirestoreUserData(user.uid);
    currentUserData = { uid: user.uid, email: user.email, nombre: fdata ? fdata.nombre : user.email, puesto: fdata ? fdata.puesto : 'Sin puesto' };
    showOptionsMenu();
  } catch (error) {
    console.error("Login error:", error);
    if (error.code === "auth/user-not-found" || error.code === "auth/invalid-credential") {
      feedbackMsg.innerText = "Usuario o contrase√±a incorrecta.";
    } else if (error.code === "auth/wrong-password") {
      feedbackMsg.innerText = "Contrase√±a incorrecta.";
    } else {
      feedbackMsg.innerText = "Error al iniciar sesi√≥n: " + (error.message || error.code);
    }
  }
});

/* Show create account modal */
document.getElementById('showCreateBtn').addEventListener('click', () => {
  createModal.style.display = "flex";
  createFeedback.innerText = "";
  document.getElementById('newName').value = "";
  document.getElementById('newPuesto').value = "";
  document.getElementById('newEmail').value = "";
  document.getElementById('newPassword').value = "";
});
document.getElementById('closeModalBtn').addEventListener('click', () => createModal.style.display = "none");

/* Create account (email + name + puesto) */
document.getElementById('createAccountBtn').addEventListener('click', async () => {
  const name = document.getElementById('newName').value.trim();
  const puesto = document.getElementById('newPuesto').value.trim();
  const email = document.getElementById('newEmail').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  createFeedback.innerText = "";
  if (!name || !puesto || !email || !password) { createFeedback.innerText = "Todos los campos son obligatorios"; return; }
  if (password.length < 6) { createFeedback.innerText = "La contrase√±a debe tener al menos 6 caracteres"; return; }
  try {
    const uc = await createUserWithEmailAndPassword(auth, email, password);
    const user = uc.user;
    await setDoc(doc(db, "usuarios", user.uid), { nombre: name, puesto: puesto, email });
    currentUserData = { uid: user.uid, email: user.email, nombre: name, puesto: puesto };
    createModal.style.display = "none";
    showOptionsMenu();
  } catch (error) {
    console.error("Create user error:", error);
    if (error.code === "auth/email-already-in-use") createFeedback.innerText = "El correo ya est√° registrado. Intenta iniciar sesi√≥n.";
    else if (error.code === "auth/weak-password") createFeedback.innerText = "Contrase√±a d√©bil. Debe tener al menos 6 caracteres.";
    else createFeedback.innerText = "Error al crear cuenta: " + (error.message || error.code);
  }
});

/* Phone (SMS) authentication flow */
phoneAuthBtn.addEventListener('click', () => {
  phoneAuthArea.style.display = phoneAuthArea.style.display === 'none' ? 'block' : 'none';
});

/* init invisible reCAPTCHA when user first clicks send SMS */
let recaptchaVerifier = null;
document.getElementById('sendSmsBtn').addEventListener('click', async () => {
  const phone = document.getElementById('phoneNumberInput').value.trim();
  createFeedback.innerText = '';
  if (!phone) { feedbackMsg.innerText = "Ingresa n√∫mero de tel√©fono con prefijo"; return; }
  feedbackMsg.innerText = "Enviando SMS...";
  try {
    // init recaptcha if not exists
    if (!recaptchaVerifier) {
      recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', { size: 'invisible' }, auth);
      await recaptchaVerifier.render();
    }
    const confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
    // store confirmationResult for verify step
    window._firebaseConfirmation = confirmationResult;
    document.getElementById('smsCodeArea').style.display = 'block';
    feedbackMsg.innerText = "C√≥digo enviado. Ingresa el c√≥digo para verificar.";
  } catch (e) {
    console.error("SMS send error:", e);
    feedbackMsg.innerText = "Error al enviar SMS: " + (e.message || e.code);
  }
});

document.getElementById('verifySmsBtn').addEventListener('click', async () => {
  const code = document.getElementById('smsCodeInput').value.trim();
  if (!code) { feedbackMsg.innerText = "Ingresa el c√≥digo recibido"; return; }
  try {
    const confirmationResult = window._firebaseConfirmation;
    if (!confirmationResult) { feedbackMsg.innerText = "No hay confirmaci√≥n previa. Reintenta enviar SMS."; return; }
    const result = await confirmationResult.confirm(code);
    const user = result.user;
    // get firestore profile if exists
    const fdata = await getFirestoreUserData(user.uid);
    currentUserData = { uid: user.uid, email: user.phoneNumber || user.email || 'phone-user', nombre: fdata ? fdata.nombre : (user.phoneNumber || 'Usuario SMS'), puesto: fdata ? fdata.puesto : 'Sin puesto' };
    feedbackMsg.innerText = "";
    showOptionsMenu();
  } catch (e) {
    console.error("SMS verify error:", e);
    feedbackMsg.innerText = "C√≥digo inv√°lido o expirado.";
  }
});

/* Logout */
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await signOut(auth);
    showLoginScreen();
  } catch (e) {
    console.error("SignOut error:", e);
  }
});

/* show options menu after login/create */
function showOptionsMenu() {
  if (!currentUserData) return showLoginScreen();
  // hide login inputs
  document.getElementById('emailInput').style.display = 'none';
  document.getElementById('passwordInput').style.display = 'none';
  document.getElementById('loginBtn').style.display = 'none';
  document.getElementById('showCreateBtn').style.display = 'none';
  document.getElementById('promptText').style.display = 'none';
  optionsMenu.style.display = 'block';
  const name = currentUserData.nombre || currentUserData.email;
  document.getElementById('welcomeUserMsg').innerText = `¬°Hola, ${name}! ¬øQu√© deseas hacer?`;
  const isCreator = currentUserData.email === CREATOR_EMAIL;
  document.getElementById('panelCreatorBtn').style.display = isCreator ? 'inline-block' : 'none';
}

/* Creator panel open */
document.getElementById('panelCreatorBtn').addEventListener('click', () => showCreatorView());
document.getElementById('backToMenuBtn').addEventListener('click', () => { creatorView.style.display = 'none'; showOptionsMenu() });

/* ====================================================
   Quiz logic (same features you requested)
   ==================================================== */
function logAccess(score, total) {
  let log = [];
  try { log = JSON.parse(localStorage.getItem(LOG_KEY)) || []; } catch (e) { log = []; }
  const newEntry = { email: currentUserData.email, name: currentUserData.nombre, puesto: currentUserData.puesto, time: new Date().toISOString(), score, total };
  log.unshift(newEntry);
  if (log.length > 200) log.pop();
  localStorage.setItem(LOG_KEY, JSON.stringify(log));
}

function loadLogList() {
  const logList = document.getElementById('logList');
  let log = []; try { log = JSON.parse(localStorage.getItem(LOG_KEY)) || []; } catch(e){ log = []; }
  logList.innerHTML = '';
  if (log.length === 0) { logList.innerHTML = '<li>No se ha registrado ning√∫n acceso.</li>'; return; }
  log.forEach(entry => {
    const li = document.createElement('li');
    const date = new Date(entry.time).toLocaleString('es-MX', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    const scoreText = entry.score !== undefined ? `${entry.score}/${entry.total}` : 'N/A';
    const scoreColor = entry.total>0 && entry.score/entry.total >= 0.7 ? '#2e7d32' : '#b71c1c';
    li.innerHTML = `<div style="width:100%"><span style="font-weight:600;color:#c8102e">${entry.name} (${entry.email})</span><div style="font-size:0.85em;color:#777">${entry.puesto}</div></div><span style="font-size:.9em;color:#555">${date}</span><span style="color:${scoreColor};font-weight:700;margin-left:8px">${scoreText}</span>`;
    logList.appendChild(li);
  });
}

document.getElementById('downloadLogBtn').addEventListener('click', () => {
  let log = []; try { log = JSON.parse(localStorage.getItem(LOG_KEY)) || []; } catch(e){ log = []; }
  if (log.length===0){ alert("Registro vac√≠o."); return; }
  const headers = ["Fecha y Hora","Correo","Nombre","Puesto","Correctas","Total","Calificacion (%)"];
  const csvRows = log.map(entry=>{
    const date = new Date(entry.time).toLocaleString('es-MX',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).replace(/,/g,'');
    const percentage = entry.total>0?((entry.score/entry.total)*100).toFixed(2):'0.00';
    return [`"${date}"`,`"${entry.email}"`,`"${entry.name.replace(/"/g,'""')}"`,`"${entry.puesto.replace(/"/g,'""')}"`,`"${entry.score}"`,`"${entry.total}"`,`"${percentage}%"`].join(';');
  });
  const csv = [headers.join(';'), ...csvRows].join('\n');
  const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`Registro_MC_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
});

document.getElementById('clearLogBtn').addEventListener('click', () => {
  if (confirm("¬øEliminar registro local? Esta acci√≥n es irreversible.")) { localStorage.removeItem(LOG_KEY); loadLogList(); }
});

/* Quiz controls */
document.getElementById('startQuizBtn').addEventListener('click', showQuizView);
document.getElementById('startBtn').addEventListener('click', () => { randomized = shuffle(quizData); currentIndex=0; correctCount=0; wrongCount=0; document.getElementById('startBtn').style.display='none'; showCurrent(); });
document.getElementById('checkBtn').addEventListener('click', checkAnswer);
document.getElementById('nextBtn').addEventListener('click', () => { currentIndex++; if (currentIndex>=randomized.length) showResults(); else showCurrent(); });
document.getElementById('finishBtn').addEventListener('click', () => { const remaining = randomized.length - (currentIndex+1); if (remaining>0) { if (!confirm(`¬øSeguro que quieres terminar? A√∫n faltan ${remaining} preguntas.`)) return; } showResults(); });
document.getElementById('restartBtn').addEventListener('click', showQuizView);

function showCreatorView(){ loginView.style.display='none'; quizView.style.display='none'; creatorView.style.display='block'; loadLogList(); }

function showQuizView(){
  if (!currentUserData) return showLoginScreen();
  loginView.style.display='none'; creatorView.style.display='none'; quizView.style.display='block';
  document.getElementById('currentUserName').innerText = `üë§ ${currentUserData.nombre} ‚Äî Puesto: ${currentUserData.puesto} | ${currentUserData.email}`;
  resetQuizState();
}

function resetQuizState(){
  randomized = shuffle(quizData);
  currentIndex = 0; correctCount = 0; wrongCount = 0;
  document.getElementById('startBtn').style.display='inline-block';
  document.getElementById('checkBtn').style.display='none';
  document.getElementById('nextBtn').style.display='none';
  document.getElementById('finishBtn').style.display='none';
  document.getElementById('restartBtn').style.display='none';
  document.getElementById('userAnswer').style.display='none';
  document.getElementById('feedback').style.display='none';
  document.getElementById('section').innerText='Presiona "Iniciar" para comenzar';
  document.getElementById('question').innerText=''; document.getElementById('sourceLine').innerText=''; document.getElementById('progress').innerText='';
}

function showCurrent(){
  if (currentIndex >= randomized.length) return showResults();
  const item = randomized[currentIndex];
  document.getElementById('section').innerText = item.section || 'Sin secci√≥n';
  document.getElementById('question').innerText = item.question || 'Sin pregunta';
  document.getElementById('sourceLine').innerText = item.source ? `Fuente: ${item.source}` : '';
  document.getElementById('userAnswer').value = '';
  document.getElementById('userAnswer').style.display='block';
  document.getElementById('feedback').style.display='none';
  document.getElementById('checkBtn').style.display='inline-block';
  document.getElementById('nextBtn').style.display='none';
  document.getElementById('finishBtn').style.display='inline-block';
  updateProgress();
}

function updateProgress(){
  document.getElementById('progress').innerText = `Pregunta ${currentIndex+1} de ${randomized.length} | ‚úÖ ${correctCount} correctas | ‚ùå ${wrongCount} incorrectas`;
}

async function checkAnswer(){
  const item = randomized[currentIndex];
  const user = document.getElementById('userAnswer').value;
  const fb = document.getElementById('feedback');
  fb.style.display = 'block';

  // 1) quick local match
  if (isSimilar(user, item.answer)) {
    correctCount++;
    fb.className='feedback correct';
    fb.innerText = `‚úÖ Correcto.\nRespuesta esperada: ${item.answer}\nFuente: ${item.source || 'Sin fuente'}`;
  } else {
    // 2) ask Gemini (if enabled) or fallback to relaxed matching
    let gemAnswer = "incorrect";
    try {
      gemAnswer = await evaluateWithGemini(user, item.answer, item.question || '');
    } catch(e) {
      console.warn("Gemini eval failed:", e);
      gemAnswer = "incorrect";
    }
    if (gemAnswer === "correct") {
      correctCount++;
      fb.className='feedback correct';
      fb.innerText = `‚úÖ Correcto (evaluado por Gemini).\nRespuesta esperada: ${item.answer}\nFuente: ${item.source || 'Sin fuente'}`;
    } else {
      // fallback: give more tolerant matching by token overlap / lower threshold
      const tolerant = tolerantSimilarity(user, item.answer);
      if (tolerant) {
        correctCount++;
        fb.className='feedback correct';
        fb.innerText = `‚úÖ Correcto (coincidencia tolerante).\nRespuesta esperada: ${item.answer}\nFuente: ${item.source || 'Sin fuente'}`;
      } else {
        wrongCount++;
        fb.className='feedback incorrect';
        fb.innerText = `‚ùå Incorrecto.\nRespuesta correcta: ${item.answer}\nFuente: ${item.source || 'Sin fuente'}`;
      }
    }
  }

  document.getElementById('checkBtn').style.display='none';
  document.getElementById('nextBtn').style.display='inline-block';
  updateProgress();
}

// tolerantSimilarity: micro fallback for flexible acceptance
function tolerantSimilarity(a,b) {
  const A = normalizeText(a);
  const B = normalizeText(b);
  if (!A || !B) return false;
  const aWords = A.split(' ').filter(Boolean);
  const bWords = B.split(' ').filter(Boolean);
  let common = 0;
  const setB = new Set(bWords);
  for (const w of aWords) if (setB.has(w)) common++;
  const ratio = common / Math.max(aWords.length, bWords.length);
  // lower threshold than isSimilar
  return ratio >= 0.45 || levenshtein(A,B)/Math.max(A.length,B.length) <= 0.35;
}

function showResults(){
  const totalQuestions = randomized.length;
  const totalAnswered = correctCount + wrongCount;
  const percentage = totalQuestions>0 ? (correctCount/totalQuestions) : 0;
  if (currentUserData) logAccess(correctCount, totalQuestions);
  const comment = percentage >= 0.9 ? "¬°Excelente trabajo! Eres un experto üçü" : percentage >= 0.7 ? "¬°Muy bien! Solo unos detalles por pulir üëè" : "Sigue practicando, vas por buen camino üí™";
  document.getElementById('section').innerText = "Resumen final";
  document.getElementById('question').innerText = `Completaste ${totalAnswered} de ${totalQuestions} preguntas.\n‚úÖ Correctas: ${correctCount}\n‚ùå Incorrectas: ${wrongCount}`;
  document.getElementById('sourceLine').innerText = comment;
  document.getElementById('userAnswer').style.display='none';
  document.getElementById('feedback').style.display='none';
  document.getElementById('checkBtn').style.display='none';
  document.getElementById('nextBtn').style.display='none';
  document.getElementById('finishBtn').style.display='none';
  document.getElementById('restartBtn').style.display='inline-block';
  document.getElementById('progress').innerText = `Tu calificaci√≥n final: ${correctCount} de ${totalQuestions}.`;
}

/* ====================================================
   Inicializaci√≥n general
   ==================================================== */
async function initApp() {
  document.getElementById('feedbackMsg').innerText = "Cargando datos del quiz...";
  quizData = await processCSV(QUIZ_CSV_URL);
  if (quizData.length>0) {
    document.getElementById('feedbackMsg').innerText = "Datos cargados. Inicia sesi√≥n para comenzar. üöÄ";
    document.getElementById('loginBtn').disabled = false;
    document.getElementById('showCreateBtn').disabled = false;
  } else {
    document.getElementById('feedbackMsg').innerText = "ERROR: No se pudo cargar la data del quiz. Revisa la URL del CSV.";
    document.getElementById('loginBtn').disabled = true;
    document.getElementById('showCreateBtn').disabled = true;
  }

  // auth state listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const fdata = await getFirestoreUserData(user.uid);
      currentUserData = { uid: user.uid, email: user.email || user.phoneNumber || 'user', nombre: fdata ? fdata.nombre : (user.email || user.phoneNumber || 'Usuario'), puesto: fdata ? fdata.puesto : 'Sin puesto' };
      if (quizData.length>0) showOptionsMenu(); else document.getElementById('feedbackMsg').innerText = "Datos del quiz pendientes...";
    } else {
      showLoginScreen();
    }
  });
}

/* small shuffle helper */
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

/* start */
initApp();
</script>
</body>
</html>
