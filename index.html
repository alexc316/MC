<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guía de Estudio MC</title>
<style>
  body { font-family: 'Poppins', sans-serif; text-align:center; background:#fffdf5; }
  .card { background:#fff; padding:30px; border-radius:20px; box-shadow:0 6px 25px rgba(0,0,0,0.15); max-width:700px; margin:40px auto; text-align:left; }
  input { width:80%; max-width:300px; padding:12px; margin:10px auto; border-radius:8px; border:2px solid #ddd; display:block; text-align:center; }
  button { margin:8px; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; font-weight:700; background:#c8102e; color:#fff; }
  .secondary { background:#555; }
  .warning { background:#ffcc00; color:#222; }
  .green-btn { background:#2e7d32; }
  #createModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  #createModal .modal-content { background:#fff; padding:20px; border-radius:15px; max-width:400px; width:90%; text-align:center; }
  #feedbackMsg { color:red; margin-top:10px; }
</style>
</head>
<body>

<div class="card">
  <h2>Bienvenido a la Guía de Estudio MC</h2>
  <div id="loginView">
    <input id="emailInput" type="email" placeholder="Correo electrónico">
    <input id="passwordInput" type="password" placeholder="Contraseña">
    <button id="loginBtn">Iniciar Sesión</button>
    <button id="showCreateBtn" class="secondary">Crear Cuenta</button>
    <p id="feedbackMsg"></p>
  </div>

  <div id="quizView" style="display:none;">
    <h3 id="userDisplay"></h3>
    <p id="section"></p>
    <p id="question"></p>
    <input id="userAnswer" type="text" placeholder="Escribe tu respuesta">
    <div id="feedback" style="display:none;"></div>
    <div>
      <button id="checkBtn">Comprobar</button>
      <button id="nextBtn">Siguiente</button>
      <button id="finishBtn" class="warning">Terminar</button>
      <button id="logoutBtn" class="secondary">Cerrar Sesión</button>
    </div>
  </div>
</div>

<!-- Modal para Crear Cuenta -->
<div id="createModal">
  <div class="modal-content">
    <h3>Crear Cuenta</h3>
    <input id="newName" placeholder="Nombre completo">
    <input id="newPuesto" placeholder="Puesto">
    <input id="newEmail" placeholder="Correo electrónico" type="email">
    <input id="newPassword" placeholder="Contraseña" type="password">
    <button id="createAccountBtn">Crear Cuenta</button>
    <button id="closeModalBtn" class="secondary">Cancelar</button>
    <p id="createFeedback" style="color:red;"></p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB57-QWSTYwBmbwf5cK0mHVJSYCdkBCxkM",
    authDomain: "mcantea.firebaseapp.com",
    projectId: "mcantea",
    storageBucket: "mcantea.appspot.com",
    messagingSenderId: "364639775835",
    appId: "1:364639775835:web:aee974c576c2e4d515237e",
    measurementId: "G-0BYWEJJ57G"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginBtn = document.getElementById('loginBtn');
  const showCreateBtn = document.getElementById('showCreateBtn');
  const feedbackMsg = document.getElementById('feedbackMsg');

  const createModal = document.getElementById('createModal');
  const createAccountBtn = document.getElementById('createAccountBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const createFeedback = document.getElementById('createFeedback');

  let currentUser = null;

  // --- LOGIN ---
  loginBtn.addEventListener('click', async () => {
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value.trim();
    feedbackMsg.innerText = "";
    if (!email || !password) { feedbackMsg.innerText="Ingresa correo y contraseña"; return; }

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      currentUser = userCredential.user;
      showQuiz(userCredential.user);
    } catch (error) {
      if (error.code === "auth/user-not-found") feedbackMsg.innerText = "Usuario no encontrado";
      else if (error.code === "auth/wrong-password") feedbackMsg.innerText = "Contraseña incorrecta";
      else feedbackMsg.innerText = error.message;
    }
  });

  // --- MOSTRAR CREAR CUENTA ---
  showCreateBtn.addEventListener('click', () => {
    createModal.style.display = "flex";
  });
  closeModalBtn.addEventListener('click', () => createModal.style.display="none");

  // --- CREAR CUENTA ---
  createAccountBtn.addEventListener('click', async () => {
    const name = document.getElementById('newName').value.trim();
    const puesto = document.getElementById('newPuesto').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    createFeedback.innerText = "";

    if (!name || !puesto || !email || !password) { createFeedback.innerText="Todos los campos son obligatorios"; return; }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      currentUser = user;

      // Guardar datos extra en Firestore
      await setDoc(doc(db, "usuarios", user.uid), { nombre: name, puesto: puesto, email });

      createModal.style.display = "none";
      showQuiz(user, name, puesto);
    } catch (error) {
      if (error.code === "auth/email-already-in-use") createFeedback.innerText = "El correo ya está registrado";
      else createFeedback.innerText = error.message;
    }
  });

  // --- MOSTRAR QUIZ ---
  function showQuiz(user, name=null, puesto=null) {
    document.getElementById('loginView').style.display="none";
    document.getElementById('quizView').style.display="block";
    const displayName = name || user.displayName || user.email;
    const displayPuesto = puesto || "";
    document.getElementById('userDisplay').innerText = `${displayName} - ${displayPuesto}`;
  }

  // --- CERRAR SESIÓN ---
  document.getElementById('logoutBtn').addEventListener('click', () => {
    location.reload(); // reinicia la página para logout
  });
</script>
</body>
</html>
